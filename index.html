<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GUTS Â°´Ë°®Â∞èÂ∑•ÂÖ∑ (Classic Theme)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Âæ©Âè§Â≠óÈ´îË®≠ÂÆö */
        body { 
            font-family: arial, sans-serif; 
            background-color: #fff; 
            font-size: 13px;
        }
        /* ÈÄ£ÁµêÊ®£Âºè */
        a { color: #0000cc; text-decoration: underline; cursor: pointer; }
        a:hover { color: #0000cc; }
        
        /* GUTS Á∂ìÂÖ∏Á∂†Ëâ≤Ê®ôÈ°å */
        .guts-header-green {
            background-color: #93c47d;
            border-top: 1px solid #93c47d;
            border-bottom: 1px solid #93c47d;
            color: #000;
            font-weight: bold;
            padding: 4px 6px;
        }

        /* Ê®°Êì¨ GUTS Ë°®Ê†º */
        .guts-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ccc;
            margin-top: 5px;
        }
        .guts-table th {
            background-color: #eee;
            text-align: left;
            padding: 4px 6px;
            border-bottom: 1px solid #ccc;
            font-weight: bold;
            color: #000;
            text-decoration: underline;
            font-size: 12px;
        }
        .guts-table td {
            padding: 6px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }
        
        /* Ëº∏ÂÖ•ÂçÄÊ®£Âºè */
        #pasteArea {
            min-height: 150px;
            max-height: 400px;
            overflow-y: auto;
            white-space: normal;
            font-family: monospace;
            background: #fff;
            border: 1px solid #ccc;
            padding: 5px;
            margin: 10px;
            outline: none;
        }
        #pasteArea:focus { border-color: #4d90fe; }

        /* Á∂ìÂÖ∏ÊåâÈàïÊ®£Âºè */
        .classic-btn {
            background: #f8f8f8;
            border: 1px solid #c6c6c6;
            color: #333;
            padding: 4px 12px;
            font-size: 13px;
            font-weight: bold;
            font-family: arial, sans-serif;
            cursor: pointer;
            border-radius: 2px;
            background-image: linear-gradient(to bottom, #fefefe, #f3f3f3);
        }
        .classic-btn:hover {
            border-color: #999;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            color: #000;
        }
        .classic-btn:active {
            background: #e9e9e9;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }

        /* ÁµêÊûúÂàóÈ´ò‰∫Æ (ÈªÉËâ≤ËÉåÊôØ) */
        .ticket-highlight {
            background-color: #fff2cc;
            border: 1px solid #fce8b2;
        }
        
        /* ÊãñÊõ≥ÈÄ£ÁµêÊ®£Âºè */
        .bookmarklet-link {
            font-weight: bold;
            font-size: 14px;
            color: #0000cc;
            cursor: grab;
        }
        .bookmarklet-link:active {
            cursor: grabbing;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Top Bar (Google Logo & Search) -->
    <div class="flex items-center p-2 mb-2 border-b border-gray-200">
        <div class="mr-4 select-none">
            <span class="text-blue-600 font-serif text-2xl font-bold">G</span>
            <span class="text-red-500 font-serif text-2xl font-bold">o</span>
            <span class="text-yellow-500 font-serif text-2xl font-bold">o</span>
            <span class="text-blue-600 font-serif text-2xl font-bold">g</span>
            <span class="text-green-600 font-serif text-2xl font-bold">l</span>
            <span class="text-red-500 font-serif text-2xl font-bold">e</span>
            <span class="text-slate-500 font-sans text-xl ml-1 font-bold italic relative -top-0.5">GUTS</span>
        </div>
        
        <div class="flex-1 flex items-center">
            <input type="text" value="Search tickets..." class="border border-gray-400 p-1 w-full max-w-lg text-sm px-2 shadow-inner bg-white text-gray-400" readonly>
            <button class="classic-btn ml-2">Search</button>
        </div>
        
        <div class="text-xs text-right text-gray-600">
            <b>user</b> | <a href="#" class="text-blue-800">Settings</a> | <a href="#" class="text-blue-800">Help</a>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="flex flex-1 px-2">
        
        <!-- Sidebar -->
        <div class="w-48 pr-4 flex-shrink-0 text-sm hidden md:block pt-2">
            <div class="mb-4 flex flex-col gap-1.5 pl-1">
                <a href="#" class="font-bold text-red-700">Compose Ticket</a>
                <div class="h-px bg-gray-300 my-1"></div>
                <a href="#" class="text-blue-900 font-bold">My Inbox</a>
                <a href="#" class="text-blue-900">Starred</a>
                <a href="#" class="text-blue-900">Sent Mail</a>
                <a href="#" class="text-blue-900">Drafts</a>
            </div>

            <div class="bg-[#e0eccd] p-1 mb-1 font-bold text-black border-t border-l border-r border-[#ccc] mt-4">Views</div>
            <div class="bg-[#93c47d] p-1 text-black font-bold flex items-center border border-[#93c47d]">
                <i class="fas fa-caret-down mr-1"></i>
                <span class="underline cursor-pointer">All Tickets</span>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 min-w-0 pt-2">
            
            <!-- Step 1: Input Area -->
            <div class="border border-[#93c47d] mb-4 shadow-sm">
                <div class="guts-header-green flex justify-between items-center">
                    <span>1. Initialize Data (Ë≤º‰∏ä Excel/HTML)</span>
                </div>
                
                <div class="bg-[#f3f3f3] p-2 border-b border-gray-300 flex justify-between items-center">
                    <span class="text-xs text-gray-600">Paste your content below:</span>
                    <button onclick="generateBookmarklet()" class="classic-btn border-green-600 text-green-800 font-bold">
                        <i class="fas fa-bolt mr-1"></i> Generate Tool
                    </button>
                </div>

                <!-- Input Div -->
                <div id="pasteArea" contenteditable="true" data-placeholder="Ë´ãÂú®Ê≠§Ë≤º‰∏äÂÖßÂÆπ..."></div>

                <div class="bg-[#f3f3f3] p-1 border-t border-gray-300 text-right">
                     <div id="statusMsg" class="text-xs text-gray-500 font-mono px-2">Waiting for input...</div>
                </div>
            </div>

            <!-- Step 2: Result Area (Table Style with Date) -->
            <div id="resultArea" class="hidden opacity-0 transition-opacity duration-500">
                <div class="flex justify-between items-end mb-1 px-1">
                     <div class="text-sm font-bold text-gray-700">Generated Ticket (Drag link to bookmarks):</div>
                     <div class="text-xs"><b>1-1</b> of <b>1</b></div>
                </div>

                <table class="guts-table">
                    <thead>
                        <tr>
                            <th style="width: 80px;">Ticket #</th>
                            <th>Summary (Bookmarklet)</th>
                            <th style="width: 100px;">Status</th>
                            <th style="width: 60px;">Priority</th>
                            <th style="width: 130px;">Date Opened</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- This Row is the Bookmarklet -->
                        <tr class="ticket-highlight">
                            <td>
                                <a href="#" class="text-blue-900">82394012</a>
                            </td>
                            <td>
                                <i class="fas fa-star text-orange-400 mr-1"></i>
                                <!-- The Actual Bookmarklet Link -->
                                <a id="bookmarkletBtn" href="javascript:void(0)" class="bookmarklet-link" title="Drag me to bookmarks bar">
                                    GUTS Â°´Ë°®Â∞èÂ∑•ÂÖ∑ V4
                                </a>
                                <span class="text-xs text-gray-500 ml-2">- Drag this link to bookmarks bar</span>
                            </td>
                            <td>
                                <span class="bg-green-100 text-green-800 px-1 border border-green-200 text-xs">Ready</span>
                            </td>
                            <td>P2</td>
                            <td id="dateDisplay" class="text-gray-600">--/--/---- --:--</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
        </div>
    </div>

    <!-- Script (Original Logic Preserved) -->
    <script>
        // Set date on load
        const now = new Date();
        const formattedDate = `${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')}/${now.getFullYear()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        document.getElementById('dateDisplay').innerText = formattedDate;

        // Bind click event to prevent default
        document.getElementById('bookmarkletBtn').addEventListener('click', function(e) {
            e.preventDefault();
            alert('Ë´ãÊãñÊõ≥Ê≠§ÈÄ£ÁµêÂà∞Êõ∏Á±§ÂàóÔºåËÄå‰∏çÊòØÁõ¥Êé•ÈªûÊìäÔºÅ\n\nPlease drag this link to your bookmarks bar.');
        });

        function parsePasteData() {
            const pasteArea = document.getElementById('pasteArea');
            if (!pasteArea.innerText.trim()) return [];

            const table = pasteArea.querySelector('table');
            const data = [];

            const getBgColor = (el) => {
                if (!el) return '#ffffff';
                if (el.style && el.style.backgroundColor) return el.style.backgroundColor;
                if (el.getAttribute('bgcolor')) return el.getAttribute('bgcolor');
                return '#ffffff';
            };
            const rgbToHex = (rgb) => {
                if (!rgb || rgb === 'transparent' || rgb.includes('rgba(0, 0, 0, 0)')) return '#ffffff';
                if (rgb.startsWith('#')) return rgb;
                try {
                    const sep = rgb.indexOf(",") > -1 ? "," : " ";
                    const parts = rgb.substr(4).split(")")[0].split(sep);
                    let r = (+parts[0]).toString(16), g = (+parts[1]).toString(16), b = (+parts[2]).toString(16);
                    if (r.length == 1) r = "0" + r; if (g.length == 1) g = "0" + g; if (b.length == 1) b = "0" + b;
                    return "#" + r + g + b;
                } catch(e) { return '#ffffff'; }
            };

            const cleanHtmlContent = (html) => {
                if (!html) return '';
                let clean = html.replace(/<meta[^>]*>/g, '');
                return clean.trim();
            };

            const isHeader = (t, c) => {
                const T = t.toLowerCase().trim();
                const C = c.toLowerCase().trim();
                const headerKeywords = [
                    'title', 'content', 'type', 'response', 
                    'Ê®ôÈ°å', 'ÂÖßÂÆπ', 'È°ûÂûã', 'ÂõûÊáâ', 
                    'Ê®ôÈ°å (title)', 'ÂÖßÂÆπ (content)', 'color', 'pinned'
                ];
                const isMatch = (val) => headerKeywords.some(k => val === k || val.startsWith(k));
                if (isMatch(T) || isMatch(C)) return true;
                return false;
            };

            const normalizeText = (text) => {
                if(!text) return '';
                return text.replace(/\t/g, ' '); 
            };

            if (table) {
                const rows = table.querySelectorAll('tr');
                rows.forEach((row, index) => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 2) {
                        const title = cells[0].innerText.trim();
                        let plain = cells[1].innerText.trim();
                        plain = normalizeText(plain); 
                        
                        if (index === 0 && isHeader(title, plain)) return; 

                        let html = cells[1].innerHTML; 
                        html = cleanHtmlContent(html); 

                        let bg = getBgColor(row);
                        if (bg === '#ffffff' || !bg) bg = getBgColor(cells[0]);
                        
                        data.push({ title, content: plain, html, color: rgbToHex(bg), pinned: false });
                    }
                });
            } else {
                const lines = pasteArea.innerText.trim().split('\n');
                lines.forEach((line, index) => {
                    let parts = line.split('\t');
                    if(parts.length < 2 && line.includes(',')) parts = line.split(','); 
                    if (parts.length >= 2) {
                        const title = parts[0].trim();
                        let content = parts[1].trim();
                        content = normalizeText(content); 

                        if (index === 0 && isHeader(title, content)) return;
                        data.push({ title, content, html: content, color: '#ffffff', pinned: false });
                    }
                });
            }
            return data;
        }

        function generateBookmarklet() {
            const statusMsg = document.getElementById('statusMsg');
            const resultArea = document.getElementById('resultArea');
            const bookmarkletBtn = document.getElementById('bookmarkletBtn');
            const parsedData = parsePasteData();
            
            if (parsedData.length === 0) {
                statusMsg.innerHTML = 'Status: <span class="text-red-600 font-bold">Empty Data</span>';
                return; 
            } else {
                statusMsg.innerHTML = `Status: <span class="text-green-700 font-bold">Processed ${parsedData.length} records</span>`;
            }
            
            resultArea.classList.remove('hidden');
            // Trigger reflow
            void resultArea.offsetWidth;
            resultArea.classList.remove('opacity-0');
            
            let jsonData = JSON.stringify(parsedData);
            jsonData = jsonData.replace(/`/g, '\\`').replace(/\$\{/g, '\\${');

            // --- BOOKMARKLET CODE ---
            const code = `
(function() {
    try {
        const STORAGE_KEY = 'GUTS_PRO_V4_DATA';
        const PREF_KEY = 'GUTS_PRO_V4_PREFS';
        const INITIAL_DATA = ${jsonData};
        
        let appData = [];
        const currentFingerprint = JSON.stringify(INITIAL_DATA);
        const storedFingerprint = localStorage.getItem(STORAGE_KEY + '_FINGERPRINT');
        const storedData = localStorage.getItem(STORAGE_KEY);

        if (INITIAL_DATA.length > 0 && currentFingerprint !== storedFingerprint) {
            appData = INITIAL_DATA;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
            localStorage.setItem(STORAGE_KEY + '_FINGERPRINT', currentFingerprint);
            setTimeout(() => {
                const t = document.createElement('div');
                t.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#10b981;color:white;padding:10px 20px;border-radius:20px;z-index:999999;font-weight:bold;font-family:sans-serif;box-shadow:0 5px 15px rgba(0,0,0,0.3);';
                t.innerText = 'Â∑≤ÂåØÂÖ•Êñ∞Ë≥áÊñôÔºÅ';
                document.body.appendChild(t);
                setTimeout(() => t.remove(), 2500);
            }, 500);
        } else {
            try { appData = storedData ? JSON.parse(storedData) : INITIAL_DATA; } catch(e) { appData = INITIAL_DATA; }
        }

        let prefs = { width: 500, iconTop: 50, iconLeft: null, isExpanded: true };
        try { prefs = { ...prefs, ...JSON.parse(localStorage.getItem(PREF_KEY)) }; } catch(e) {}

        const ROOT_ID = 'guts-pro-v4-root';
        if(document.getElementById(ROOT_ID)) return; 

        /* SVGs */
        const ICONS = {
            bolt: '<svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>',
            plus: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M12 5v14M5 12h14"/></svg>',
            export: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>',
            minus: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M5 12h14"/></svg>',
            close: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M18 6L6 18M6 6l12 12"/></svg>',
            paste: '<svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4h-4.18C12 9.4 12 9.6 12 10c0 .55.45 1 1 1h4v-2z"/></svg>',
            edit: '<svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>',
            trash: '<svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>',
            grip: '<svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>',
            pin: '<svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M16 9V4h1c.55 0 1-.45 1-1s-.45-1-1-1H7c-.55 0-1 .45-1 1s.45 1 1 1h1v5c0 1.66-1.34 3-3 3v2h5.97v7l1 1 1-1v-7H19v-2c-1.66 0-3-1.34-3-3z"/></svg>',
            max: '<svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>',
            min: '<svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/></svg>'
        };

        const styleId = 'guts-pro-v4-style';
        if (!document.getElementById(styleId)) {
            const s = document.createElement('style'); s.id = styleId;
            s.innerHTML = \`
                #guts-pro-v4-root { font-family: 'Segoe UI', 'Roboto', sans-serif; font-size: 14px; line-height: 1.5; color: #333; z-index: 2147483647; position: fixed; }
                
                /* CSS RESET FOR PREVIEW (V6.1) */
                .gp-preview p, .gp-preview div, .gp-preview h1, .gp-preview h2 {
                    margin: 0 !important; padding: 0 !important; line-height: 1.5 !important;
                }
                .gp-preview br { display: block; content: ""; margin: 0; }

                #guts-icon { position: fixed; top: \${prefs.iconTop}px; \${prefs.iconLeft !== null ? 'left:' + prefs.iconLeft + 'px;' : 'right: 20px;'} width: 50px; height: 50px; background: #0f172a; color: white; border-radius: 50%; cursor: move; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.4); transition: transform 0.1s; z-index: 2147483647; border: 2px solid #fff; }
                #guts-icon:hover { transform: scale(1.1); }
                #guts-panel { position: fixed; top: 0; right: 0; bottom: 0; width: \${prefs.width}px; background: #f8fafc; box-shadow: -5px 0 30px rgba(0,0,0,0.15); display: none; flex-direction: column; border-left: 1px solid #e2e8f0; }
                .gp-header { padding: 15px 20px; background: #0f172a; color: white; display: flex; flex-direction: column; gap: 12px; }
                .gp-title { font-weight: bold; font-size: 18px; display:flex; gap:8px; align-items:center; }
                .gp-controls { display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; }
                .gp-btn-action { background: rgba(255,255,255,0.08); color: #cbd5e1; padding: 8px 4px; border-radius: 6px; cursor: pointer; text-align: center; font-size: 12px; display: flex; flex-direction: column; align-items: center; gap: 5px; transition: 0.2s; border: 1px solid transparent; }
                .gp-btn-action:hover { background: rgba(255,255,255,0.15); color: #fff; }
                .gp-body { flex: 1; overflow-y: auto; padding: 15px; }
                
                .gp-item { background: white; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 12px; overflow: hidden; display: flex; align-items: stretch; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
                .gp-item:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); border-color: #cbd5e1; }
                .gp-item-left { width: 80px; background: #f1f5f9; border-right: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 10px; }
                .gp-fill-btn { width: 100%; height: 100%; min-height: 40px; background: linear-gradient(135deg, #10b981, #059669); color: white; border-radius: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3); transition: 0.2s; }
                .gp-fill-btn:hover { transform: scale(1.05); } .gp-fill-btn:active { transform: scale(0.95); }
                .gp-fill-text { font-size: 11px; font-weight: bold; margin-top:2px; }
                .gp-item-mid { flex: 1; padding: 12px 15px; display: flex; flex-direction: column; justify-content: center; cursor: default; }
                .gp-item-title { font-weight: 600; font-size: 15px; color: #334155; line-height: 1.4; display: flex; align-items: center; gap: 5px; }
                .gp-item-right { display: flex; align-items: center; gap: 6px; padding-right: 12px; background: transparent; }
                .gp-icon-btn { width: 32px; height: 32px; border-radius: 8px; border: 1px solid transparent; background: transparent; color: #94a3b8; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
                .gp-icon-btn.edit:hover { background: #eff6ff; color: #3b82f6; } .gp-icon-btn.delete:hover { background: #fef2f2; color: #ef4444; }
                .gp-drag-handle { width: 20px; height: 100%; display: flex; align-items: center; justify-content: center; cursor: grab; color: #cbd5e1; margin-left: 4px; }
                
                .gp-preview { 
                    position: fixed; display: none; background: #ffffff; border: 1px solid #cbd5e1; 
                    box-shadow: 0 10px 40px rgba(0,0,0,0.25); padding: 20px; border-radius: 8px; 
                    z-index: 2147483647; 
                    width: max-content; max-width: 80vw; max-height: 80vh; overflow-y: auto; 
                    pointer-events: none;
                    white-space: pre-wrap; word-break: break-word; line-height: 1.5;
                }
                
                #gp-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 600px; height: 500px; background: #fff; z-index: 2147483648; display: none; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); border-radius: 12px; border: 1px solid #cbd5e1; }
                #gp-modal.expanded { width: 95vw; height: 95vh; }
                .gp-modal-head { padding: 15px; border-bottom: 1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; background:#f8fafc; border-radius: 12px 12px 0 0; }
                .gp-modal-body { flex:1; padding: 15px; display:flex; flex-direction:column; gap: 15px; overflow-y:auto; }
                .gp-input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 15px; }
                .gp-toolbar { display: flex; gap: 5px; flex-wrap: wrap; background: #f1f5f9; padding: 5px; border-radius: 6px 6px 0 0; border: 1px solid #cbd5e1; border-bottom: none; align-items: center; }
                .gp-tool-btn { padding: 4px 8px; cursor: pointer; border: 1px solid transparent; background: transparent; font-weight: bold; font-size: 14px; border-radius: 4px; display: flex; align-items: center; gap: 4px; }
                .gp-tool-btn:hover { background: #e2e8f0; }
                .gp-color-picker { width: 24px; height: 24px; padding: 0; border: none; background: transparent; cursor: pointer; }
                .gp-rich-editor { width: 100%; flex: 1; border: 1px solid #cbd5e1; border-radius: 0 0 6px 6px; padding: 15px; font-size: 14px; overflow-y: auto; outline: none; background: white; line-height: 1.6; }
                .gp-modal-foot { padding: 15px; border-top: 1px solid #e2e8f0; display:flex; justify-content: flex-end; gap: 10px; background:#f8fafc; border-radius: 0 0 12px 12px; }
                .gp-btn { padding: 8px 20px; border-radius: 6px; cursor: pointer; border:none; font-weight:bold; }
                .gp-btn-primary { background: #0f172a; color: white; }
                .gp-btn-default { background: #e2e8f0; color: #334155; }
                .gp-resizer { position: absolute; top:0; bottom:0; left:0; width:5px; cursor: col-resize; z-index: 10; }
                .gp-toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.85); color: white; padding: 15px 25px; border-radius: 30px; opacity: 0; transition: 0.2s; pointer-events:none; font-weight:bold; z-index: 2147483647; text-align: center;}
                .gp-toast.show { opacity: 1; }
                .gp-bg-picker { width: 40px; height: 25px; border:none; padding:0; background:transparent; cursor:pointer; }
                #gp-context-menu { position: fixed; background: white; border: 1px solid #cbd5e1; box-shadow: 0 5px 15px rgba(0,0,0,0.2); border-radius: 6px; display: none; z-index: 2147483649; font-size: 13px; }
                .gp-menu-item { padding: 10px 20px; cursor: pointer; color: #334155; display: flex; align-items: center; gap: 8px; }
                .gp-menu-item:hover { background: #f1f5f9; }
                .gp-menu-item.danger { color: #ef4444; border-top: 1px solid #e2e8f0; }
                #gp-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); z-index: 2147483647; display: none; backdrop-filter: blur(2px); }
            \`;
            document.head.appendChild(s);
        }

        const root = document.createElement('div'); root.id = ROOT_ID;
        const icon = document.createElement('div'); icon.id = 'guts-icon'; icon.innerHTML = ICONS.bolt;
        const panel = document.createElement('div'); panel.id = 'guts-panel';
        const overlay = document.createElement('div'); overlay.id = 'gp-overlay';
        const ctxMenu = document.createElement('div'); ctxMenu.id = 'gp-context-menu';
        
        ctxMenu.innerHTML = \`<div class="gp-menu-item" id="ctx-open">\${ICONS.plus} ÈñãÂïüÈÅ∏ÂñÆ</div><div class="gp-menu-item danger" id="ctx-close">\${ICONS.close} ÈóúÈñâÁ®ãÂºè</div>\`;
        
        panel.innerHTML = \`
            <div class="gp-resizer" id="gp-resizer"></div>
            <div class="gp-header">
                <div class="gp-title">GUTSÂ°´Ë°®Â∞èÂπ´Êâã <span style="font-size:12px;opacity:0.6">V</span></div>
                <div class="gp-controls">
                    <div class="gp-btn-action" id="gp-add">\${ICONS.plus} Êñ∞Â¢û</div>
                    <div class="gp-btn-action" id="gp-export">\${ICONS.export} ÂåØÂá∫</div>
                    <div class="gp-btn-action" id="gp-min">\${ICONS.minus} Á∏ÆÂ∞è</div>
                    <div class="gp-btn-action" id="gp-close" style="color:#fca5a5;">\${ICONS.close} ÈóúÈñâ</div>
                </div>
            </div>
            <div class="gp-body" id="gp-list"></div>
        \`;
        
        const modal = document.createElement('div'); modal.id = 'gp-modal';
        modal.innerHTML = \`
            <div class="gp-modal-head">
                <span class="gp-title" style="color:#333">Á∑®ËºØÂÖßÂÆπ</span>
                <button class="gp-icon-btn" id="gp-max-toggle" title="ÊîæÂ§ß/Á∏ÆÂ∞è">\${ICONS.max}</button>
            </div>
            <div class="gp-modal-body">
                <div><span class="gp-label">Ê®ôÈ°å</span><input class="gp-input" id="edit-title" placeholder="Ëº∏ÂÖ•Ê®ôÈ°å..."></div>
                <div style="flex:1; display:flex; flex-direction:column;">
                    <span class="gp-label">ÂÖßÂÆπ (ÊâÄË¶ãÂç≥ÊâÄÂæó)</span>
                    <div class="gp-toolbar">
                        <button class="gp-tool-btn" data-cmd="bold"><b>B</b></button>
                        <button class="gp-tool-btn" data-cmd="italic"><i>I</i></button>
                        <button class="gp-tool-btn" data-cmd="underline"><u>U</u></button>
                        <div style="display:flex;align-items:center;gap:3px;font-size:12px;margin-right:5px;">A <input type="color" class="gp-color-picker" id="cmd-foreColor" value="#000000"></div>
                        <div style="display:flex;align-items:center;gap:3px;font-size:12px;margin-right:5px;">Bg <input type="color" class="gp-color-picker" id="cmd-hiliteColor" value="#ffffff"></div>
                        <button class="gp-tool-btn" data-cmd="removeFormat">Ê∏ÖÈô§</button>
                    </div>
                    <div id="edit-rich-content" class="gp-rich-editor" contenteditable="true"></div>
                </div>
                <div style="background:#f1f5f9; padding:10px; border-radius:6px; display:flex; align-items:center; gap:10px;">
                    <label style="cursor:pointer; display:flex; align-items:center; font-weight:bold;">
                        <input type="checkbox" id="edit-pinned" style="margin-right:5px; transform:scale(1.2);"> ÁΩÆÈ†Ç
                    </label>
                    <div class="gp-bg-picker-wrap">
                        <span style="font-size:12px;font-weight:bold;">Âç°ÁâáËÉåÊôØ:</span>
                        <input type="color" id="edit-bg-color" class="gp-bg-picker" value="#ffffff">
                    </div>
                </div>
            </div>
            <div class="gp-modal-foot">
                <button class="gp-btn gp-btn-default" id="edit-cancel">ÂèñÊ∂à</button>
                <button class="gp-btn gp-btn-primary" id="edit-save">ÂÑ≤Â≠ò</button>
            </div>
        \`;

        const previewBox = document.createElement('div'); previewBox.className = 'gp-preview'; previewBox.id = 'gp-preview-box';
        
        root.appendChild(overlay); root.appendChild(icon); root.appendChild(panel); root.appendChild(modal); root.appendChild(previewBox); root.appendChild(ctxMenu);
        document.body.appendChild(root);

        let currentEditIdx = -1;
        const pnl = panel; const icn = icon;

        const save = () => { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); render(); };
        const savePrefs = () => { localStorage.setItem(PREF_KEY, JSON.stringify(prefs)); };

        const render = () => {
            const list = document.getElementById('gp-list'); list.innerHTML = '';
            const sorted = appData.map((d, i) => ({...d, _idx: i})).sort((a,b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                return 0; 
            });
            
            sorted.forEach(item => {
                const el = document.createElement('div'); el.className = \`gp-item \${item.pinned ? 'pinned' : ''}\`;
                el.draggable = true;
                el.style.backgroundColor = item.color || '#ffffff';
                el.innerHTML = \`
                    <div class="gp-item-left" id="btn-insert-\${item._idx}" title="Â°´ÂÖ•ÂÖßÂÆπ"><div class="gp-fill-btn">\${ICONS.paste}<span class="gp-fill-text">Â°´ÂÖ•</span></div></div>
                    <div class="gp-item-mid" id="info-\${item._idx}"><div class="gp-item-title">\${item.pinned ? ICONS.pin : ''} \${item.title}</div></div>
                    <div class="gp-item-right">
                        <button class="gp-icon-btn edit" id="btn-edit-\${item._idx}" title="Á∑®ËºØ">\${ICONS.edit}</button>
                        <button class="gp-icon-btn delete" id="btn-del-\${item._idx}" title="Âà™Èô§">\${ICONS.trash}</button>
                        <div class="gp-drag-handle" title="ÊãñÊõ≥ÊéíÂ∫è">\${ICONS.grip}</div>
                    </div>
                \`;
                el.querySelector(\`#btn-insert-\${item._idx}\`).onclick = async (e) => { e.stopPropagation(); await copyToClipboard(item); fillWorklog(item); };
                el.querySelector(\`#btn-edit-\${item._idx}\`).onclick = (e) => { e.stopPropagation(); openEdit(item._idx); };
                el.ondblclick = (e) => { e.stopPropagation(); openEdit(item._idx); };
                el.querySelector(\`#btn-del-\${item._idx}\`).onclick = (e) => { 
                    e.stopPropagation(); 
                    if(confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÂóéÔºü')) {
                        const realIdx = appData.findIndex((_, i) => i === item._idx);
                        if(realIdx > -1) { appData.splice(realIdx, 1); save(); }
                    }
                };
                el.ondragstart = (e) => { e.dataTransfer.setData('text/plain', item._idx); el.style.opacity = '0.5'; };
                el.ondragover = (e) => { e.preventDefault(); };
                el.ondragend = () => { el.style.opacity = '1'; };
                el.ondrop = (e) => {
                    e.stopPropagation();
                    const fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
                    if(fromIdx !== item._idx) {
                        const element = appData[fromIdx]; appData.splice(fromIdx, 1); appData.splice(item._idx, 0, element); save();
                    }
                };
                el.querySelector(\`#info-\${item._idx}\`).onmouseenter = () => {
                    const pb = document.getElementById('gp-preview-box'); pb.innerHTML = item.html || item.content;
                    pb.style.display = 'block'; const rect = el.getBoundingClientRect();
                    pb.style.top = rect.top + 'px'; pb.style.right = (prefs.width + 10) + 'px';
                };
                el.querySelector(\`#info-\${item._idx}\`).onmouseleave = () => { document.getElementById('gp-preview-box').style.display = 'none'; };
                list.appendChild(el);
            });
        };

        const copyToClipboard = async (item) => {
            try {
                const blobHtml = new Blob([item.html || item.content], { type: 'text/html' });
                const blobText = new Blob([item.content], { type: 'text/plain' });
                await navigator.clipboard.write([new ClipboardItem({ 'text/html': blobHtml, 'text/plain': blobText })]);
                showToast('Â∑≤Ë§áË£ΩÔºÅ');
            } catch(e) {}
        };

        // --- OLD HELPER: KEEP FOR RICH TEXT INSERT ---
        const normalizeHtmlForInsert = (rawHtml) => {
            if (!rawHtml) return '';
            const div = document.createElement('div');
            div.innerHTML = rawHtml;
            const blocks = div.querySelectorAll('p, div, h1, h2, h3, h4, h5, h6, ul, ol, li');
            blocks.forEach(el => { el.style.margin = '0'; el.style.padding = '0'; el.style.lineHeight = '1.5'; });
            const walker = document.createTreeWalker(div, NodeFilter.SHOW_TEXT, null, false);
            let node;
            while(node = walker.nextNode()) { node.nodeValue = node.nodeValue.replace(/\t/g, ' '); }
            return div.innerHTML;
        };

        const fillWorklog = (item) => {
            let target = null;
            const xpath = "//*[contains(text(), 'Update Worklog')]";
            const result = document.evaluate(xpath, document.body, null, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null);
            for (let i = 0; i < result.snapshotLength; i++) {
                const node = result.snapshotItem(i);
                if(node.offsetParent === null) continue;
                let container = node.parentElement; 
                let candidate = findInputBelow(container);
                if(candidate) { target = candidate; break; }
                candidate = findInputBelow(container.parentElement);
                if(candidate) { target = candidate; break; }
            }
            if (!target) target = document.querySelector('textarea[aria-label*="Worklog"], textarea[placeholder*="Worklog"]');
            if (!target && document.activeElement && (document.activeElement.tagName === 'TEXTAREA' || document.activeElement.isContentEditable)) target = document.activeElement;

            if (target) {
                target.focus();
                
                if (target.isContentEditable) {
                    // 1. Rich Text Field (HTML Insert)
                    const compactHtml = normalizeHtmlForInsert(item.html || item.content);
                    document.execCommand('insertHTML', false, compactHtml);
                } else {
                    // 2. Plain Text Field / Textarea (FIX)
                    // Explicitly convert HTML structure to text with newlines
                    const start = target.selectionStart || 0; const end = target.selectionEnd || 0;
                    
                    const temp = document.createElement('div');
                    temp.innerHTML = item.html || item.content;
                    
                    // Replace <br> with newline literal
                    temp.querySelectorAll('br').forEach(br => br.replaceWith('\\n'));
                    
                    // Append newline to block elements to enforce line breaks
                    temp.querySelectorAll('div, p, li, h1, h2, h3, tr').forEach(el => {
                        el.appendChild(document.createTextNode('\\n'));
                    });
                    
                    let cleanVal = temp.textContent;
                    
                    target.value = target.value.substring(0, start) + cleanVal + target.value.substring(end);
                    target.dispatchEvent(new Event('input', {bubbles: true}));
                }
                showToast('Â∑≤ÊèíÂÖ•ÔºÅ');
            } else { showToast('Â∑≤Ë§áË£Ω (Êú™ÊâæÂà∞Ê¨Ñ‰Ωç)'); }
        };

        const findInputBelow = (root) => {
            if(!root) return null;
            const walker = document.createTreeWalker(root, NodeFilter.SHOW_ELEMENT);
            while(walker.nextNode()) {
                const el = walker.currentNode;
                if((el.tagName === 'TEXTAREA' || el.isContentEditable) && el.offsetParent !== null) return el;
            }
            let next = root.nextElementSibling;
            while(next) {
                if((next.tagName === 'TEXTAREA' || next.isContentEditable) && next.offsetParent !== null) return next;
                const inner = next.querySelector('textarea, [contenteditable="true"]');
                if(inner && inner.offsetParent !== null) return inner;
                next = next.nextElementSibling;
            }
            return null;
        }

        const showToast = (msg) => {
            const t = document.getElementById('gp-toast'); t.innerText = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        };

        const openEdit = (idx) => {
            currentEditIdx = idx;
            const item = (idx === -1) ? { title: '', html: '', pinned: false, color: '#ffffff' } : appData[idx];
            document.getElementById('edit-title').value = item.title;
            document.getElementById('edit-rich-content').innerHTML = item.html || item.content || '';
            document.getElementById('edit-pinned').checked = item.pinned;
            document.getElementById('edit-bg-color').value = item.color || '#ffffff';
            document.getElementById('gp-overlay').style.display = 'block';
            document.getElementById('gp-modal').style.display = 'flex';
        };
        
        document.querySelectorAll('.gp-tool-btn').forEach(btn => {
            btn.onmousedown = (e) => { e.preventDefault(); document.execCommand(btn.dataset.cmd, false, btn.dataset.val||null); };
        });

        // --- COLOR FIX: RESTORE SELECTION BEFORE APPLYING COLOR ---
        const editor = document.getElementById('edit-rich-content');
        let savedRange = null;

        const saveSelection = () => {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                const range = sel.getRangeAt(0);
                if (editor.contains(range.commonAncestorContainer)) {
                    savedRange = range;
                }
            }
        };

        editor.addEventListener('keyup', saveSelection);
        editor.addEventListener('mouseup', saveSelection);
        editor.addEventListener('input', saveSelection);

        const applyColor = (cmd, val) => {
            editor.focus();
            if (savedRange) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(savedRange);
            }
            document.execCommand(cmd, false, val);
            saveSelection();
        };

        document.getElementById('cmd-foreColor').onchange = (e) => applyColor('foreColor', e.target.value);
        document.getElementById('cmd-hiliteColor').onchange = (e) => applyColor('hiliteColor', e.target.value);
        
        document.getElementById('gp-max-toggle').onclick = () => { const m = document.getElementById('gp-modal'); const btn = document.getElementById('gp-max-toggle'); m.classList.toggle('expanded'); btn.innerHTML = m.classList.contains('expanded') ? ICONS.min : ICONS.max; };

        document.getElementById('edit-save').onclick = () => {
            const title = document.getElementById('edit-title').value;
            const html = document.getElementById('edit-rich-content').innerHTML;
            const plain = document.getElementById('edit-rich-content').innerText;
            const color = document.getElementById('edit-bg-color').value;
            const pinned = document.getElementById('edit-pinned').checked;
            const newItem = { title: title||'Êú™ÂëΩÂêç', content: plain, html: html, pinned: pinned, color: color };
            if(currentEditIdx === -1) appData.push(newItem); else appData[currentEditIdx] = newItem;
            save(); closeEdit();
        };
        
        const closeEdit = () => { document.getElementById('gp-overlay').style.display = 'none'; document.getElementById('gp-modal').style.display = 'none'; };
        document.getElementById('edit-cancel').onclick = closeEdit;
        document.getElementById('gp-add').onclick = () => openEdit(-1);
        
        document.getElementById('gp-min').onclick = () => { pnl.style.display='none'; icn.style.display='flex'; prefs.isExpanded=false; savePrefs(); };
        const openPanel = () => { icn.style.display='none'; pnl.style.display='flex'; prefs.isExpanded=true; savePrefs(); };
        icn.onclick = openPanel;
        document.getElementById('gp-close').onclick = () => root.remove();
        if(prefs.isExpanded) { icn.style.display='none'; pnl.style.display='flex'; } else { icn.style.display='flex'; pnl.style.display='none'; }

        icn.oncontextmenu = (e) => { e.preventDefault(); ctxMenu.style.display='block'; ctxMenu.style.top=e.clientY+'px'; ctxMenu.style.left=(e.clientX+10)+'px'; };
        document.addEventListener('click', (e) => { if (!e.target.closest('#gp-context-menu')) ctxMenu.style.display='none'; });
        document.getElementById('ctx-open').onclick = () => { ctxMenu.style.display='none'; openPanel(); };
        document.getElementById('ctx-close').onclick = () => { ctxMenu.style.display='none'; root.remove(); };

        let isDrag = false;
        icn.onmousedown = (e) => {
            if(e.button===2)return; e.preventDefault(); const sX=e.clientX-icn.getBoundingClientRect().left, sY=e.clientY-icn.getBoundingClientRect().top;
            const move = (pX,pY) => { icn.style.left=(pX-sX)+'px'; icn.style.top=(pY-sY)+'px'; icn.style.right='auto'; };
            const onMM = (ev) => { isDrag=true; move(ev.clientX, ev.clientY); };
            const onMU = () => { document.removeEventListener('mousemove',onMM); document.removeEventListener('mouseup',onMU); if(isDrag){prefs.iconLeft=parseInt(icn.style.left); prefs.iconTop=parseInt(icn.style.top); savePrefs();} setTimeout(()=>isDrag=false,50); };
            document.addEventListener('mousemove',onMM); document.addEventListener('mouseup',onMU);
        };
        icn.addEventListener('click', (e) => { if(isDrag) e.stopImmediatePropagation(); }, true);
        const resizer = document.getElementById('gp-resizer');
        resizer.onmousedown = (e) => {
            e.preventDefault(); const sX=e.clientX, sW=parseInt(window.getComputedStyle(pnl).width);
            const onMM = (ev) => { const nW=sW+(sX-ev.clientX); if(nW>300 && nW<800) pnl.style.width=nW+'px'; };
            const onMU = () => { prefs.width=parseInt(pnl.style.width); savePrefs(); document.removeEventListener('mousemove',onMM); document.removeEventListener('mouseup',onMU); };
            document.addEventListener('mousemove',onMM); document.addEventListener('mouseup',onMU);
        };

        /* EXPORT AS WEBPAGE (V5.5 Order + Font Style Fix) */
        document.getElementById('gp-export').onclick = () => {
            const sortedExport = appData.map((d, i) => ({...d, _idx: i}))
                .sort((a,b) => {
                    if (a.pinned && !b.pinned) return -1;
                    if (!a.pinned && b.pinned) return 1;
                    return 0; 
                });

            let htmlBody = \`<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<title>GUTS Pro ÂÇô‰ªΩË≥áÊñô</title>
<style>
    body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f0fdf4; }
    .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    h1 { color: #166534; text-align: center; font-size: 24px; margin-bottom: 20px; }
    .btn { display: block; width: 100%; padding: 15px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-bottom: 20px; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    
    table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
    th, td { border: 1px solid #cbd5e1; padding: 12px; text-align: left; vertical-align: top; }
    th { background: #f1f5f9; color: #475569; font-weight: bold; font-size: 11pt; } 
    
    td { 
        font-size: 10pt;
        line-height: 1; /* Export spacing set to 1 */ 
        white-space: pre-wrap; 
        word-wrap: break-word; 
        word-break: break-all;
        max-width: 0;
    }
</style>
</head>
<body>
<div class="container">
    <h1>GUTS Â∞èÂπ´Êâã Ë≥áÊñôÂÇô‰ªΩ</h1>
    <button class="btn" onclick="copyAll()">üìã ÈªûÊ≠§Ë§áË£ΩÂÖ®ÈÉ® (Copy All)</button>
    <div id="status" style="text-align:center; margin-bottom:10px; color:#166534; font-weight:bold; height:20px;"></div>
    <table id="dataTable">
        <thead>
            <tr>
                <th style="width: 25%">Ê®ôÈ°å (Title)</th>
                <th>ÂÖßÂÆπ (Content)</th>
            </tr>
        </thead>
        <tbody>\`;

            sortedExport.forEach(r => {
               let bgStyle = r.color ? \`background-color:\${r.color};\` : '';
               let contentHtml = r.html || r.content || '';
               htmlBody += \`<tr><td style="\${bgStyle}">\${r.title}</td><td style="\${bgStyle}">\${contentHtml}</td></tr>\`;
            });
            
            htmlBody += \`        </tbody>
    </table>
</div>
<script>
    function copyAll() {
        const table = document.getElementById('dataTable');
        const range = document.createRange();
        range.selectNode(table);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        try {
            document.execCommand('copy');
            document.getElementById('status').innerText = '‚úÖ Â∑≤Ë§áË£ΩÔºÅË´ãÂõûÂà∞ GUTS Áî¢ÁîüÂô®Ë≤º‰∏äÈÇÑÂéü„ÄÇ';
            setTimeout(() => document.getElementById('status').innerText = '', 3000);
        } catch (err) {
            alert('Ë§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãïÈÅ∏ÂèñË§áË£Ω');
        }
    }
<\/script>
</body>
</html>\`;
            
            const blob = new Blob([htmlBody], { type: 'text/html' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "GUTS_Backup.html";
            link.click();
        };

        render();
    } catch(err) {
        alert('GUTS Pro ÂïüÂãïÂ§±Êïó: ' + err.message);
    }
})();
            `;

            const cleanCode = code.trim();
            const href = "javascript:" + encodeURIComponent(cleanCode);
            // FIX: Explicitly get the element by ID to ensure it works in all strict modes
            document.getElementById('bookmarkletBtn').href = href;
        }
    </script>
</body>
</html>
